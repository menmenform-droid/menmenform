<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Offline Stock Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; margin: 15px; }
  h2 { margin-bottom: 10px; }
  input, button { padding: 10px; margin: 5px 0; width: 100%; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #888; padding: 8px; text-align: center; }
  #previewVideo { width: 100%; display: none; margin-top: 10px; }
  .popup {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; border: 1px solid #333; padding: 20px; display:none;
  }
  .popup button { width: 30%; margin: 5px; }
</style>
</head>
<body>

<h2>Offline Stock Inventory System</h2>

<input type="text" id="barcodeInput" placeholder="Enter or Scan Barcode">
<button id="scanBtn">Scan with Camera</button>

<video id="previewVideo" playsinline></video>

<!-- Popup when same barcode appears -->
<div class="popup" id="popupBox">
  <p id="popupText"></p>
  <button id="ignoreBtn">Ignore</button>
  <button id="plusOneBtn">+1</button>
  <button id="editQtyBtn">Edit Qty</button>
</div>

<button id="exportBtn">Export CSV</button>

<table id="inventoryTable">
  <thead>
    <tr><th>Barcode</th><th>Quantity</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let inventory = JSON.parse(localStorage.getItem("inventory") || "{}");
const tableBody = document.querySelector("#inventoryTable tbody");

// Load table on start
function refreshTable() {
  tableBody.innerHTML = "";
  for (let code in inventory) {
    let row = `<tr><td>${code}</td><td>${inventory[code]}</td></tr>`;
    tableBody.insertAdjacentHTML("beforeend", row);
  }
}
refreshTable();

// Handle barcode input
document.getElementById("barcodeInput").addEventListener("change", () => {
  processBarcode(document.getElementById("barcodeInput").value.trim());
  document.getElementById("barcodeInput").value = "";
});

// Process scanned or typed barcode
function processBarcode(code) {
  if (!code) return;
  if (inventory[code]) {
    showPopup(code);
  } else {
    inventory[code] = 1;
    save();
  }
}

// Save and update UI
function save() {
  localStorage.setItem("inventory", JSON.stringify(inventory));
  refreshTable();
}

// Popup for duplicate barcode
function showPopup(code) {
  let popup = document.getElementById("popupBox");
  document.getElementById("popupText").innerText = 
    `Barcode: ${code}\nCurrent Qty: ${inventory[code]}`;
  popup.style.display = "block";

  document.getElementById("ignoreBtn").onclick = () => { popup.style.display = "none"; };
  document.getElementById("plusOneBtn").onclick = () => { inventory[code]++; save(); popup.style.display = "none"; };
  document.getElementById("editQtyBtn").onclick = () => {
    let newQty = prompt("Enter new quantity:", inventory[code]);
    if (newQty !== null) { inventory[code] = Number(newQty); save(); }
    popup.style.display = "none";
  };
}

/* Barcode Scanner */
const video = document.getElementById("previewVideo");
document.getElementById("scanBtn").addEventListener("click", async () => {
  if (!("BarcodeDetector" in window)) {
    alert("Your browser does not support BarcodeDetector. Use Chrome/Edge.");
    return;
  }

  video.style.display = "block";
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
  video.srcObject = stream;
  video.play();

  const detector = new BarcodeDetector({ formats: ["ean_13", "code_128", "qr_code"] });

  const scanLoop = async () => {
    try {
      const barcodes = await detector.detect(video);
      if (barcodes.length > 0) {
        processBarcode(barcodes[0].rawValue);
      }
    } catch (e) {}
    requestAnimationFrame(scanLoop);
  };
  scanLoop();
});

// Export CSV
document.getElementById("exportBtn").addEventListener("click", () => {
  let csv = "barcode,quantity\n";
  for (let code in inventory) csv += `${code},${inventory[code]}\n`;

  let blob = new Blob([csv], { type: "text/csv" });
  let link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "inventory.csv";
  link.click();
});
</script>
</body>
</html>

