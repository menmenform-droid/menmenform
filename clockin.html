<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üìç ClockIn ‚Äî Attendance System</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f3f6fa; }
h2 { color: #2c3e50; }
#camera { width: 90%; max-width: 400px; margin: 10px auto; border: 2px solid #ccc; border-radius: 10px; }
button { padding: 10px 16px; margin: 8px; border: none; border-radius: 8px; background: #1976d2; color: white; cursor: pointer; }
button:disabled { background: #aaa; }
#log { background: #fff; border-radius: 10px; padding: 10px; max-width: 400px; margin: 20px auto; text-align: left; height: 160px; overflow-y: auto; font-size: 14px; border: 1px solid #ccc; }
#photo { width: 90%; max-width: 400px; display: none; margin: 10px auto; border: 2px solid #ccc; border-radius: 10px; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<h2>üìç ClockIn ‚Äî Attendance System</h2>

<div id="g_id_onload"
  data-client_id="117751523765-l034timkav8017o0odm6fdpbuo50mmbq.apps.googleusercontent.com"
  data-context="signin"
  data-ux_mode="popup"
  data-callback="onSignIn">
</div>
<div class="g_id_signin" data-type="standard"></div>

<div id="main" style="display:none;">
  <p>Signed in as: <b id="userEmail"></b></p>
  <video id="camera" autoplay playsinline></video><br>
  <canvas id="canvas" style="display:none;"></canvas>
  <img id="photo" alt="Captured photo"><br>
  <textarea id="note" placeholder="Write a note..." rows="2" cols="30"></textarea><br>
  <button id="btnCapture">üì∏ Capture</button>
  <button id="btnSubmit" disabled>‚úÖ Submit</button>
</div>

<div id="log"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyH7MusGoS17l-b31cQaavJ5dgzQOpNjV4eBq7w0KCFfa_wjQ4gmGid_Rhpw6MDQ86Z3Q/exec";

let userEmail = '';
let lat = '', lng = '';
let photoData = '';

function log(msg){
  const logBox = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  logBox.innerHTML += `[${time}] ${msg}<br>`;
  logBox.scrollTop = logBox.scrollHeight;
}

// Google Sign-In
function onSignIn(response){
  const credential = decodeJwtResponse(response.credential);
  userEmail = credential.email;
  document.getElementById('userEmail').textContent = userEmail;
  document.getElementById('main').style.display = 'block';
  log(`Signed in as ${userEmail}`);
  startCamera();
  getLocation();
}

function decodeJwtResponse(token){
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
  ).join(''));
  return JSON.parse(jsonPayload);
}

// Start camera
function startCamera(){
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      document.getElementById('camera').srcObject = stream;
      log('Camera started.');
    })
    .catch(err => {
      log('Camera error: ' + err);
    });
}

// Get location
function getLocation(){
  if(!navigator.geolocation){
    log('Geolocation not supported.');
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    lat = pos.coords.latitude;
    lng = pos.coords.longitude;
    log(`Location detected: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
  }, err => {
    log('Location error: ' + err.message);
  }, { enableHighAccuracy: true });
}

// Capture photo
document.getElementById('btnCapture').onclick = () => {
  if(!lat || !lng){
    log(‚ö†Ô∏è Please enable location before taking photo.');
    return;
  }
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  photoData = canvas.toDataURL('image/jpeg');
  document.getElementById('photo').src = photoData;
  document.getElementById('photo').style.display = 'block';
  document.getElementById('btnSubmit').disabled = false;
  log('Photo captured.');
};

// Submit data
document.getElementById('btnSubmit').onclick = async () => {
  const note = document.getElementById('note').value.trim();
  if(!photoData){ log('‚ö†Ô∏è Please capture a photo first.'); return; }

  const data = new URLSearchParams({
    email: userEmail,
    lat, lng,
    note,
    photo: photoData
  });

  log('Uploading...');
  try{
    const res = await fetch(SCRIPT_URL, { method: 'POST', body: data });
    const text = await res.text();
    if(text.includes('OK')){
      log('‚úÖ Upload successful!');
      document.getElementById('btnSubmit').disabled = true;
    }else{
      log('‚ùå Upload failed, will retry...');
      retrySubmit(data);
    }
  }catch(err){
    log('Network error: ' + err + ' Retrying...');
    retrySubmit(data);
  }
};

// Retry upload on failure
function retrySubmit(data){
  setTimeout(async () => {
    try{
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: data });
      const text = await res.text();
      if(text.includes('OK')) log('‚úÖ Retry successful!');
      else retrySubmit(data);
    }catch(e){
      retrySubmit(data);
    }
  }, 5000);
}
</script>
</body>
</html>
