<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>check in â€” Clock In (Offline Ready)</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial; padding: 18px; max-width:720px; margin:auto; }
video, img { width:100%; max-height:420px; border-radius:8px; background:#111; }
button { padding:10px 14px; margin:6px; border-radius:8px; }
#main { display:none; }
#log { background:#f8f8f8; border:1px solid #ddd; border-radius:8px; padding:10px; font-size:0.9rem; max-height:180px; overflow:auto; white-space:pre-wrap; }
.small { font-size:0.9rem; color:#444; }
#preview { margin-top:10px; max-height:220px; border-radius:8px; }
</style>
</head>
<body>
<h2>ğŸ“ check in â€” Clock In (Offline Ready)</h2>
<div id="login"></div>

<div id="main">
<p>ğŸ‘¤ <strong id="email">not signed</strong></p>
<p id="geo" class="small">å®šä½ä¸­â€¦</p>

<video id="video" autoplay playsinline></video>
<img id="preview" style="display:none;" alt="æ‹ç…§é¢„è§ˆ">

<p>
  <button id="snap">ğŸ“¸ ambil gambar</button>
  <button id="submit">âœ… hantar</button>
</p>
<p><textarea id="note" rows="2" style="width:100%" placeholder="remark"></textarea></p>

<h3>ğŸ§¾ Log</h3>
<div id="log"></div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytcHEFzAacwcpwIqg7-wVeHC3fz3jnqfZlUeMlTlXClcKFL72J20bqNlMoSYcs34k/exec';
const CLIENT_ID = '117751523765-l034timkav8017o0odm6fdpbuo50mmbq.apps.googleusercontent.com';

let email='', lat='', lng='', photoData='';
const logEl = document.getElementById('log');
const previewEl = document.getElementById('preview');

// æ—¥å¿—æ˜¾ç¤º
function log(msg){ 
  const t = new Date().toLocaleTimeString();
  logEl.textContent += `[${t}] ${msg}\n`; 
  logEl.scrollTop = logEl.scrollHeight;
}

// Google Sign-in
window.onload = () => {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCredentialResponse
  });
  google.accounts.id.renderButton(document.getElementById('login'), { theme:'outline', size:'large' });
  checkOfflineQueue();
};

function handleCredentialResponse(response){
  const payload = parseJwt(response.credential);
  email = payload.email || '';
  document.getElementById('email').innerText = email;
  document.getElementById('login').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  startCamera();
  getLocation();
}

function parseJwt(token){
  try{
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g,'+').replace(/_/g,'/');
    return JSON.parse(decodeURIComponent(escape(window.atob(base64))));
  } catch(e){ return {}; }
}

// å®šä½
function getLocation(){
  if(!navigator.geolocation){ document.getElementById('geo').innerText='âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒå®šä½'; return;}
  navigator.geolocation.getCurrentPosition(p=>{
    lat=p.coords.latitude; lng=p.coords.longitude;
    document.getElementById('geo').innerHTML=`ğŸ“ <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank">${lat.toFixed(6)},${lng.toFixed(6)}</a>`;
    log('ğŸ“ å®šä½æˆåŠŸ');
  }, err=>{
    document.getElementById('geo').innerText='âš ï¸ æ— æ³•è·å–ä½ç½®ï¼ˆè¯·å¼€å¯å®šä½ï¼‰';
    lat=''; lng='';
    log('âš ï¸ å®šä½å¤±è´¥ï¼Œæ— æ³•æ‹ç…§æˆ–æäº¤');
  }, { enableHighAccuracy:true });
}

// æ‘„åƒå¤´
let stream=null;
async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    const video = document.getElementById('video');
    video.srcObject = stream;
    await video.play();
  } catch(e){ alert('æ— æ³•å¯åŠ¨ç›¸æœºï¼š'+e.message); }
}

// æ‹ç…§
document.getElementById('snap').addEventListener('click', ()=>{
  if(!lat||!lng){ alert('âš ï¸ è¯·å…ˆå¼€å¯å®šä½ï¼Œæ‰èƒ½æ‹ç…§'); return;}
  const video=document.getElementById('video');
  if(!video||!video.videoWidth){ alert('ç›¸æœºæœªå°±ç»ª'); return;}
  const canvas=document.createElement('canvas');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0);
  ctx.fillStyle='rgba(0,0,0,0.5)';
  ctx.fillRect(8,canvas.height-36,260,28);
  ctx.fillStyle='#fff';
  ctx.font='16px sans-serif';
  const now=new Date();
  ctx.fillText(now.toLocaleString(),12,canvas.height-15);
  photoData=canvas.toDataURL('image/jpeg',0.85);
  previewEl.src = photoData;
  previewEl.style.display='block';
  log('ğŸ“¸ æ‹ç…§å®Œæˆï¼Œé¢„è§ˆå·²æ˜¾ç¤º');
});

// ä¿å­˜åˆ° localStorage
function saveOffline(data){
  let queue = JSON.parse(localStorage.getItem('clockinQueue')||'[]');
  queue.push(data);
  localStorage.setItem('clockinQueue', JSON.stringify(queue));
  log('âš ï¸ ç½‘ç»œä¸å¯ç”¨ï¼Œå·²ç¼“å­˜æœ¬æ¬¡æ‰“å¡');
}

// è‡ªåŠ¨ä¸Šä¼ é˜Ÿåˆ—
async function checkOfflineQueue(){
  let queue = JSON.parse(localStorage.getItem('clockinQueue')||'[]');
  if(queue.length===0) return;
  log(`ğŸ”„ æ£€æµ‹åˆ°${queue.length}æ¡ç¦»çº¿æ‰“å¡ï¼Œå°è¯•ä¸Šä¼ ...`);
  for(let i=0;i<queue.length;i++){
    try{
      const resp = await fetch(SCRIPT_URL,{method:'POST',body:new URLSearchParams(queue[i])});
      if(resp.ok){
        log(`âœ… ç¦»çº¿æ‰“å¡ä¸Šä¼ æˆåŠŸï¼š${queue[i].note||''}`);
        queue.splice(i,1);
        i--;
      } else { log(`âŒ ä¸Šä¼ å¤±è´¥ï¼š${await resp.text()}`); }
    } catch(e){ log('âŒ ç½‘ç»œé”™è¯¯ï¼Œç¨åå†è¯•'); }
  }
  localStorage.setItem('clockinQueue', JSON.stringify(queue));
}

// æäº¤æ‰“å¡
document.getElementById('submit').addEventListener('click', async ()=>{
  if(!email){ alert('è¯·å…ˆç”¨ Google ç™»å½•'); return;}
  if(!lat||!lng){ alert('âš ï¸ è¯·å…ˆå¼€å¯å®šä½ï¼Œæ‰èƒ½æäº¤'); return;}
  if(!photoData){ alert('âš ï¸ è¯·å…ˆæ‹ç…§'); return;}
  const note=document.getElementById('note').value||'';
  const data={email,lat,lng,note,photo:photoData};
  try{
    const resp=await fetch(SCRIPT_URL,{method:'POST',body:new URLSearchParams(data)});
    if(resp.ok){ alert('âœ… æ‰“å¡æˆåŠŸ'); log('âœ… æ‰“å¡ä¸Šä¼ æˆåŠŸ'); previewEl.style.display='none'; location.reload();}
    else { alert('âŒ ä¸Šä¼ å¤±è´¥ï¼Œå·²ç¼“å­˜'); saveOffline(data);}
  } catch(e){
    saveOffline(data);
  }
});

// ç›‘å¬ç½‘ç»œæ¢å¤è‡ªåŠ¨ä¸Šä¼ 
window.addEventListener('online', ()=>{ log('ğŸŒ ç½‘ç»œæ¢å¤ï¼Œå¼€å§‹ä¸Šä¼ ç¦»çº¿æ‰“å¡'); checkOfflineQueue(); });
</script>
</body>
</html>


